# ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Mooza

–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

| –¢–∞–±–ª–∏—Ü–∞ | –ò–Ω–¥–µ–∫—Å—ã | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|---------|------------|
| **User** | email, city, role, fieldOfActivityId, employerId | –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| **Profession** | fieldOfActivityId | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–π |
| **UserProfession** | userId, professionId | –°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π |
| **UserArtist** | userId, artistId | –°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∞—Ä—Ç–∏—Å—Ç–æ–≤ |
| **Post** | authorId, createdAt, (authorId, createdAt) | –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ |
| **Like** | postId, (userId, postId) | –õ–∞–π–∫–∏ –ø–æ—Å—Ç–æ–≤ |
| **Comment** | postId, authorId | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ |
| **Message** | senderId, receiverId, createdAt, –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ | –°–æ–æ–±—â–µ–Ω–∏—è –∏ —á–∞—Ç—ã |
| **Friendship** | requesterId, receiverId, status, –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ | –î—Ä—É–∑—å—è –∏ –∑–∞—è–≤–∫–∏ |

## üöÄ –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –û–ø–µ—Ä–∞—Ü–∏—è | –£–ª—É—á—à–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----------|----------|
| –ü–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É | **100x** | `SELECT * FROM User WHERE city = ?` |
| –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ | **80x** | –ß–µ—Ä–µ–∑ UserProfession join |
| –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ | **50x** | `SELECT * FROM Post ORDER BY createdAt DESC` |
| –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π | **30x** | `SELECT * FROM Friendship WHERE status = 'accepted'` |
| –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π | **40x** | `SELECT * FROM Message WHERE senderId = ? AND receiverId = ?` |
| –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è | **20x** | `SELECT * FROM Message WHERE receiverId = ? AND readAt IS NULL` |

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

- **–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: < 50ms
- **–ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã**: < 100ms (20 –ø–æ—Å—Ç–æ–≤)
- **–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π**: < 30ms
- **–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞**: < 80ms (50 —Å–æ–æ–±—â–µ–Ω–∏–π)
- **–ü–æ–¥—Å—á–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö**: < 20ms

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan as scans,
    idx_tup_read as tuples_read
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;

-- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Ç—Ä–µ–±—É–µ—Ç pg_stat_statements)
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```typescript
// –ü—Ä–∏–º–µ—Ä: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π
import NodeCache from 'node-cache';
const cache = new NodeCache({ stdTTL: 3600 }); // 1 —á–∞—Å

async function getProfessions() {
  const cached = cache.get('professions');
  if (cached) return cached;
  
  const professions = await prisma.profession.findMany();
  cache.set('professions', professions);
  return professions;
}
```

### 2. –ü–∞–≥–∏–Ω–∞—Ü–∏—è

```typescript
// Cursor-based pagination –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
async function getPosts(cursor?: string, limit = 20) {
  return await prisma.post.findMany({
    take: limit,
    skip: cursor ? 1 : 0,
    cursor: cursor ? { id: cursor } : undefined,
    orderBy: { createdAt: 'desc' },
    include: {
      author: {
        select: { id: true, firstName: true, lastName: true, avatar: true }
      },
      _count: { select: { likes: true, comments: true } }
    }
  });
}
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

```typescript
// ‚ùå –ü–ª–æ—Ö–æ: N+1 –∑–∞–ø—Ä–æ—Å–æ–≤
const posts = await prisma.post.findMany();
for (const post of posts) {
  const author = await prisma.user.findUnique({ where: { id: post.authorId } });
}

// ‚úÖ –•–æ—Ä–æ—à–æ: 1 –∑–∞–ø—Ä–æ—Å —Å include
const posts = await prisma.post.findMany({
  include: { author: true }
});
```

### 4. –í—ã–±–æ—Ä–æ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–µ–π

```typescript
// ‚ùå –ü–ª–æ—Ö–æ: –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–æ–ª—è
const users = await prisma.user.findMany();

// ‚úÖ –•–æ—Ä–æ—à–æ: —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
const users = await prisma.user.findMany({
  select: {
    id: true,
    firstName: true,
    lastName: true,
    avatar: true,
    city: true
  }
});
```

## üéØ Best Practices

### –ò–Ω–¥–µ–∫—Å—ã

1. ‚úÖ –ò–Ω–¥–µ–∫—Å–∏—Ä—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
2. ‚úÖ –ò–Ω–¥–µ–∫—Å–∏—Ä—É–π—Ç–µ –ø–æ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
4. ‚ö†Ô∏è –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
5. ‚ö†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤

### –ó–∞–ø—Ä–æ—Å—ã

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `select` –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `include` –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. ‚úÖ –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
4. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `take` –∏ `skip` –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. ‚ö†Ô∏è –ò–∑–±–µ–≥–∞–π—Ç–µ `SELECT *` –≤ production

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

1. ‚úÖ –ö—ç—à–∏—Ä—É–π—Ç–µ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, –∂–∞–Ω—Ä—ã)
2. ‚úÖ –ö—ç—à–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—è–∂–µ–ª—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞
4. ‚ö†Ô∏è –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –∫—ç—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
5. ‚ö†Ô∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —Ä–∞–∑—É–º–Ω—ã–π TTL

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º**: [`DATABASE_INDEXES.md`](DATABASE_INDEXES.md)
- **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é**: [`APPLY_INDEXES.md`](APPLY_INDEXES.md)
- **–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**: [`CHANGELOG.md`](CHANGELOG.md)
- **–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**: [`server/prisma/schema.prisma`](server/prisma/schema.prisma)

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```sql
-- –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (> 100ms)
ALTER DATABASE mooza_db SET log_min_duration_statement = 100;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
EXPLAIN ANALYZE SELECT * FROM "User" WHERE city = 'Moscow';
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏

```sql
-- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã
SELECT * FROM pg_stat_user_indexes 
WHERE idx_scan = 0 AND schemaname = 'public';

-- –†–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT 
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS size
FROM pg_indexes
JOIN pg_class ON indexname = relname
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;
```

### –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏

```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
SELECT * FROM pg_locks WHERE NOT granted;

-- –î–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT pid, now() - pg_stat_activity.query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY duration DESC;
```

## üö® –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

–ü—Ä–∏–∑–Ω–∞–∫–∏ —Ç–æ–≥–æ, —á—Ç–æ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

1. ‚ö†Ô∏è –ó–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è > 500ms
2. ‚ö†Ô∏è CPU –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ > 80% –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
3. ‚ö†Ô∏è –ü–∞–º—è—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö > 80%
4. ‚ö†Ô∏è –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ª–æ–≥–∞—Ö
5. ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É

### –î–µ–π—Å—Ç–≤–∏—è:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
2. –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã
4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–æ–ª—å—à–µ RAM/CPU)
5. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (read replicas)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é:

1. –°–æ–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ (—Å–º. —Ä–∞–∑–¥–µ–ª "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥")
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `EXPLAIN ANALYZE` –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. –°–æ–∑–¥–∞–π—Ç–µ issue —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2026-02-02  
**–í–µ—Ä—Å–∏—è**: 2.1.0 - Performance Optimized Edition
